<policies>
    <inbound>
        <base />
        <!-- Validate Azure AD JWT Token -->
        <validate-azure-ad-token tenant-id="{{McpTenantId}}" failed-validation-httpcode="401" failed-validation-error-message="Unauthorized">
            <audiences>
                <audience>{{McpMSLearnClientId}}</audience>
            </audiences>
        </validate-azure-ad-token>
        <trace source="inbound-start">
            <message>@("MCP Learn Inbound processing started for request: " + context.RequestId)</message>
        </trace>
		<set-variable name="requestBody" value="@{
            return context.Request.Body != null ? context.Request.Body.As<string>(preserveContent: true) : "";
        }" />
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
        <set-variable name="responseBody" value="Dont Access the Response Body" />
		<trace source="SucceedInformation" severity="error">
			<message>MCP Learn SucceedInformation</message>
			<metadata name="Request.Body" value="@((context.Request.Body == null || String.IsNullOrEmpty((string)context.Variables["requestBody"])) ? "-none-" : (string)context.Variables["requestBody"])" />
			<metadata name="Response.Body" value="@((context.Response.Body == null || String.IsNullOrEmpty((string)context.Variables["responseBody"])) ? "-none-" : (string)context.Variables["responseBody"])" />
		</trace>
    </outbound>
    <on-error>
        <base />
        <choose>
            <when condition="@(context.Response.StatusCode == 401)">
                <return-response>
                    <set-status code="401" reason="Unauthorized" />
                    <set-header name="WWW-Authenticate" exists-action="override">
                        <value>Bearer error="invalid_token", resource_metadata="{{APIMGatewayURL}}/.well-known/oauth-protected-resource"</value>
                    </set-header>
                </return-response>
            </when>
        </choose>
        <!-- Handle authentication/authorization errors -->
    </on-error>
</policies>